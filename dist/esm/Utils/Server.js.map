{"version":3,"file":"Server.js","names":["express","bodyParser","https","helmet","cookieParser","cors","debug","path","fileURLToPath","provAuthDebug","__dirname","dirname","import","meta","url","Server","constructor","ssl","ENCRYPTIONKEY","corsOpt","serverAddon","app","server","use","req","res","next","decodeURIComponent","err","status","send","error","details","message","frameguard","contentSecurityPolicy","undefined","origin","callback","credentials","options","urlencoded","extended","json","raw","text","headers","authorization","headerParts","split","length","tokenBody","tokenBodyParts","ltik","token","additional","query","body","parts","listen","port","Promise","resolve","reject","createServer","on","setStaticPath","static","index","close"],"sources":["../../../src/esm/Utils/Server.js"],"sourcesContent":["// Express server\nimport express from 'express'\nimport bodyParser from 'body-parser'\nimport https from 'https'\nimport helmet from 'helmet'\nimport cookieParser from 'cookie-parser'\nimport cors from 'cors'\nimport debug from 'debug'\nimport path from 'path'\nimport { fileURLToPath } from 'url'\n\nconst provAuthDebug = debug('provider:auth')\n// ESM専用の書き方で__dirnameを取得\nconst __dirname = path.dirname(fileURLToPath(import.meta.url))\n\nclass Server {\n  constructor (https, ssl, ENCRYPTIONKEY, corsOpt, serverAddon) {\n    this.app = express()\n\n    this.server = false\n\n    this.ssl = false\n    if (https) this.ssl = ssl\n\n    // Handling URI decode vulnerability\n    this.app.use(async (req, res, next) => {\n      try {\n        decodeURIComponent(req.path)\n        return next()\n      } catch (err) {\n        return res.status(400).send({ status: 400, error: 'Bad Request', details: { message: 'URIError: Failed to decode param' } })\n      }\n    })\n\n    // Setting up helmet\n    this.app.use(helmet({\n      frameguard: false, // Disabling frameguard so that Ltijs can send resources to iframes inside LMS's\n      contentSecurityPolicy: false\n    }))\n\n    // Controlling cors, having in mind that resources in another domain need to be explicitly allowed, and that ltijs controls origin blocking unregistered platforms\n    // This block of code allows cors specifying the host instead of just returnin '*'. And then ltijs blocks requests from unregistered platforms. (Except for whitelisted routes)\n    if (corsOpt === undefined || corsOpt) {\n      this.app.use(cors({\n        origin: (origin, callback) => {\n          callback(null, true)\n        },\n        credentials: true\n      }))\n      this.app.options('*', cors())\n    }\n    this.app.use(bodyParser.urlencoded({ extended: false }))\n    this.app.use(bodyParser.json())\n    this.app.use(bodyParser.raw())\n    this.app.use(bodyParser.text())\n    this.app.use(cookieParser(ENCRYPTIONKEY))\n    this.app.use(async (req, res, next) => {\n      // Creating Authorization schema LTIK-AUTH-V1\n      if (req.headers && req.headers.authorization) {\n        const headerParts = req.headers.authorization.split('LTIK-AUTH-V1 Token=')\n        if (headerParts.length > 1) {\n          provAuthDebug('Validating LTIK-AUTH-V1 Authorization schema')\n          try {\n            const tokenBody = headerParts[1]\n\n            // Get ltik\n            const tokenBodyParts = tokenBody.split(',')\n            const ltik = tokenBodyParts[0]\n            req.token = ltik\n\n            // Get additional Authorization headers\n            const additional = tokenBody.split('Additional=')\n            if (additional.length > 1) req.headers.authorization = additional[1]\n          } catch (err) {\n            provAuthDebug('Error validating LTIK-AUTH-V1 Authorization schema')\n            provAuthDebug(err)\n          }\n        }\n      }\n      return next()\n    })\n    this.app.use(async (req, res, next) => {\n      // Return if req.token is already defined\n      if (req.token) return next()\n      // Attempt to retrieve ltik from query parameters\n      if (req.query && req.query.ltik) {\n        req.token = req.query.ltik\n        return next()\n      }\n      // Attempt to retrieve ltik from body parameters\n      if (req.body && req.body.ltik) {\n        req.token = req.body.ltik\n        return next()\n      }\n      // Attempt to retrieve ltik from Bearer Authorization header\n      if (req.headers.authorization) {\n        const parts = req.headers.authorization.split(' ')\n        if (parts.length === 2 && parts[0] === 'Bearer') {\n          req.token = parts[1]\n          return next()\n        }\n      }\n      return next()\n    })\n\n    // Executing server addon\n    if (serverAddon) serverAddon(this.app)\n  }\n\n  listen (port) {\n    return new Promise((resolve, reject) => {\n      if (this.ssl) {\n        this.server = https.createServer(this.ssl, this.app).listen(port)\n      } else {\n        this.server = this.app.listen(port)\n      }\n      this.server.on('listening', () => {\n        resolve(true)\n      })\n      this.server.on('error', (err) => {\n        reject(err)\n      })\n    })\n  }\n\n  setStaticPath (path) {\n    this.app.use('/', express.static(path, { index: '_' }))\n  }\n\n  close () {\n    if (this.server) this.server.close()\n  }\n}\n\nexport default Server\n"],"mappings":"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","ignoreList":[]}