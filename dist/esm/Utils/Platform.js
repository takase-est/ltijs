function _classPrivateFieldLooseBase(receiver, privateKey) { if (!Object.prototype.hasOwnProperty.call(receiver, privateKey)) { throw new TypeError("attempted to use private field on non-instance"); } return receiver; }
var id = 0;
function _classPrivateFieldLooseKey(name) { return "__private_" + id++ + "_" + name; }
// Utils
import Auth from './Auth.js';
import debug from 'debug';
const provPlatformDebug = debug('provider:platform');

/**
 * @description Class representing a registered platform.
 */
var _platformName = /*#__PURE__*/_classPrivateFieldLooseKey("platformName");
var _platformUrl = /*#__PURE__*/_classPrivateFieldLooseKey("platformUrl");
var _clientId = /*#__PURE__*/_classPrivateFieldLooseKey("clientId");
var _authenticationEndpoint = /*#__PURE__*/_classPrivateFieldLooseKey("authenticationEndpoint");
var _authConfig2 = /*#__PURE__*/_classPrivateFieldLooseKey("authConfig");
var _ENCRYPTIONKEY2 = /*#__PURE__*/_classPrivateFieldLooseKey("ENCRYPTIONKEY");
var _accesstokenEndpoint = /*#__PURE__*/_classPrivateFieldLooseKey("accesstokenEndpoint");
var _authorizationServer = /*#__PURE__*/_classPrivateFieldLooseKey("authorizationServer");
var _kid = /*#__PURE__*/_classPrivateFieldLooseKey("kid");
var _Database = /*#__PURE__*/_classPrivateFieldLooseKey("Database");
class Platform {
  /**
     * @param {string} name - Platform name.
     * @param {string} platformUrl - Platform url.
     * @param {string} clientId - Client Id generated by the platform.
     * @param {string} authenticationEndpoint - Authentication endpoint that the tool will use to authenticate within the platform.
     * @param {string} accesstokenEndpoint - Access token endpoint for the platform.
     * @param {string} authorizationServer - Authorization server identifier to be used as the aud when requesting an access token. If not specified, the access token endpoint URL will be used.
     * @param {string} kid - Key id for local keypair used to sign messages to this platform.
     * @param {string} _ENCRYPTIONKEY - Encryption key used
     * @param {Object} _authConfig - Authentication configurations for the platform.
     */
  constructor(name, platformUrl, clientId, authenticationEndpoint, accesstokenEndpoint, authorizationServer, kid, _ENCRYPTIONKEY, _authConfig, Database) {
    Object.defineProperty(this, _platformName, {
      writable: true,
      value: void 0
    });
    Object.defineProperty(this, _platformUrl, {
      writable: true,
      value: void 0
    });
    Object.defineProperty(this, _clientId, {
      writable: true,
      value: void 0
    });
    Object.defineProperty(this, _authenticationEndpoint, {
      writable: true,
      value: void 0
    });
    Object.defineProperty(this, _authConfig2, {
      writable: true,
      value: void 0
    });
    Object.defineProperty(this, _ENCRYPTIONKEY2, {
      writable: true,
      value: void 0
    });
    Object.defineProperty(this, _accesstokenEndpoint, {
      writable: true,
      value: void 0
    });
    Object.defineProperty(this, _authorizationServer, {
      writable: true,
      value: void 0
    });
    Object.defineProperty(this, _kid, {
      writable: true,
      value: void 0
    });
    Object.defineProperty(this, _Database, {
      writable: true,
      value: void 0
    });
    _classPrivateFieldLooseBase(this, _authConfig2)[_authConfig2] = _authConfig;
    _classPrivateFieldLooseBase(this, _ENCRYPTIONKEY2)[_ENCRYPTIONKEY2] = _ENCRYPTIONKEY;
    _classPrivateFieldLooseBase(this, _platformName)[_platformName] = name;
    _classPrivateFieldLooseBase(this, _platformUrl)[_platformUrl] = platformUrl;
    _classPrivateFieldLooseBase(this, _clientId)[_clientId] = clientId;
    _classPrivateFieldLooseBase(this, _authenticationEndpoint)[_authenticationEndpoint] = authenticationEndpoint;
    _classPrivateFieldLooseBase(this, _accesstokenEndpoint)[_accesstokenEndpoint] = accesstokenEndpoint;
    _classPrivateFieldLooseBase(this, _authorizationServer)[_authorizationServer] = authorizationServer;
    _classPrivateFieldLooseBase(this, _kid)[_kid] = kid;
    _classPrivateFieldLooseBase(this, _Database)[_Database] = Database;
  }

  /**
   * @description Gets the platform url.
   */
  async platformUrl() {
    return _classPrivateFieldLooseBase(this, _platformUrl)[_platformUrl];
  }

  /**
   * @description Gets the platform client id.
   */
  async platformClientId() {
    return _classPrivateFieldLooseBase(this, _clientId)[_clientId];
  }

  /**
     * @description Sets/Gets the platform name.
     * @param {string} [name] - Platform name.
     */
  async platformName(name) {
    if (!name) return _classPrivateFieldLooseBase(this, _platformName)[_platformName];
    await _classPrivateFieldLooseBase(this, _Database)[_Database].Modify(false, 'platform', {
      platformUrl: _classPrivateFieldLooseBase(this, _platformUrl)[_platformUrl],
      clientId: _classPrivateFieldLooseBase(this, _clientId)[_clientId]
    }, {
      platformName: name
    });
    _classPrivateFieldLooseBase(this, _platformName)[_platformName] = name;
    return name;
  }

  /**
     * @description Gets the platform Id.
     */
  async platformId() {
    return _classPrivateFieldLooseBase(this, _kid)[_kid];
  }

  /**
   * @description Gets the platform key_id.
   */
  async platformKid() {
    return _classPrivateFieldLooseBase(this, _kid)[_kid];
  }

  /**
   * @description Sets/Gets the platform status.
   * @param {Boolean} [active] - Whether the Platform is active or not.
   */
  async platformActive(active) {
    if (active === undefined) {
      // Get platform status
      const platformStatus = await _classPrivateFieldLooseBase(this, _Database)[_Database].Get(false, 'platformStatus', {
        id: _classPrivateFieldLooseBase(this, _kid)[_kid]
      });
      if (!platformStatus || platformStatus[0].active) return true;else return false;
    }
    await _classPrivateFieldLooseBase(this, _Database)[_Database].Replace(false, 'platformStatus', {
      id: _classPrivateFieldLooseBase(this, _kid)[_kid]
    }, {
      id: _classPrivateFieldLooseBase(this, _kid)[_kid],
      active
    });
    return active;
  }

  /**
     * @description Gets the RSA public key assigned to the platform.
     *
     */
  async platformPublicKey() {
    const key = await _classPrivateFieldLooseBase(this, _Database)[_Database].Get(_classPrivateFieldLooseBase(this, _ENCRYPTIONKEY2)[_ENCRYPTIONKEY2], 'publickey', {
      kid: _classPrivateFieldLooseBase(this, _kid)[_kid]
    });
    return key[0].key;
  }

  /**
     * @description Gets the RSA private key assigned to the platform.
     *
     */
  async platformPrivateKey() {
    const key = await _classPrivateFieldLooseBase(this, _Database)[_Database].Get(_classPrivateFieldLooseBase(this, _ENCRYPTIONKEY2)[_ENCRYPTIONKEY2], 'privatekey', {
      kid: _classPrivateFieldLooseBase(this, _kid)[_kid]
    });
    return key[0].key;
  }

  /**
     * @description Sets/Gets the platform authorization configurations used to validate it's messages.
     * @param {string} method - Method of authorization "RSA_KEY" or "JWK_KEY" or "JWK_SET".
     * @param {string} key - Either the RSA public key provided by the platform, or the JWK key, or the JWK keyset address.
     */
  async platformAuthConfig(method, key) {
    if (!method && !key) return _classPrivateFieldLooseBase(this, _authConfig2)[_authConfig2];
    if (method && method !== 'RSA_KEY' && method !== 'JWK_KEY' && method !== 'JWK_SET') throw new Error('INVALID_METHOD. Details: Valid methods are "RSA_KEY", "JWK_KEY", "JWK_SET".');
    const authConfig = {
      method: method || _classPrivateFieldLooseBase(this, _authConfig2)[_authConfig2].method,
      key: key || _classPrivateFieldLooseBase(this, _authConfig2)[_authConfig2].key
    };
    await _classPrivateFieldLooseBase(this, _Database)[_Database].Modify(false, 'platform', {
      platformUrl: _classPrivateFieldLooseBase(this, _platformUrl)[_platformUrl],
      clientId: _classPrivateFieldLooseBase(this, _clientId)[_clientId]
    }, {
      authConfig
    });
    _classPrivateFieldLooseBase(this, _authConfig2)[_authConfig2] = authConfig;
    return authConfig;
  }

  /**
   * @description Sets/Gets the platform authorization endpoint used to perform the OIDC login.
   * @param {string} [authenticationEndpoint - Platform authentication endpoint.
   */
  async platformAuthenticationEndpoint(authenticationEndpoint) {
    if (!authenticationEndpoint) return _classPrivateFieldLooseBase(this, _authenticationEndpoint)[_authenticationEndpoint];
    await _classPrivateFieldLooseBase(this, _Database)[_Database].Modify(false, 'platform', {
      platformUrl: _classPrivateFieldLooseBase(this, _platformUrl)[_platformUrl],
      clientId: _classPrivateFieldLooseBase(this, _clientId)[_clientId]
    }, {
      authEndpoint: authenticationEndpoint
    });
    _classPrivateFieldLooseBase(this, _authenticationEndpoint)[_authenticationEndpoint] = authenticationEndpoint;
    return authenticationEndpoint;
  }

  /**
     * @description Sets/Gets the platform access token endpoint used to authenticate messages to the platform.
     * @param {string} [accesstokenEndpoint] - Platform access token endpoint.
     */
  async platformAccessTokenEndpoint(accesstokenEndpoint) {
    if (!accesstokenEndpoint) return _classPrivateFieldLooseBase(this, _accesstokenEndpoint)[_accesstokenEndpoint];
    await _classPrivateFieldLooseBase(this, _Database)[_Database].Modify(false, 'platform', {
      platformUrl: _classPrivateFieldLooseBase(this, _platformUrl)[_platformUrl],
      clientId: _classPrivateFieldLooseBase(this, _clientId)[_clientId]
    }, {
      accesstokenEndpoint
    });
    _classPrivateFieldLooseBase(this, _accesstokenEndpoint)[_accesstokenEndpoint] = accesstokenEndpoint;
    return accesstokenEndpoint;
  }

  /**
   * @description Sets/Gets the platform authorization server identifier used as the aud claim when requesting access tokens.
   * @param {string} [authorizationServer] - authorization server identifier.
   */
  async platformAuthorizationServer(authorizationServer) {
    if (!authorizationServer) return _classPrivateFieldLooseBase(this, _authorizationServer)[_authorizationServer] || _classPrivateFieldLooseBase(this, _accesstokenEndpoint)[_accesstokenEndpoint];
    await _classPrivateFieldLooseBase(this, _Database)[_Database].Modify(false, 'platform', {
      platformUrl: _classPrivateFieldLooseBase(this, _platformUrl)[_platformUrl],
      clientId: _classPrivateFieldLooseBase(this, _clientId)[_clientId]
    }, {
      authorizationServer
    });
    _classPrivateFieldLooseBase(this, _authorizationServer)[_authorizationServer] = authorizationServer;
    return authorizationServer;
  }

  /**
     * @description Gets the platform access token or attempts to generate a new one.
     * @param {String} scopes - String of scopes.
     */
  async platformAccessToken(scopes) {
    const result = await _classPrivateFieldLooseBase(this, _Database)[_Database].Get(_classPrivateFieldLooseBase(this, _ENCRYPTIONKEY2)[_ENCRYPTIONKEY2], 'accesstoken', {
      platformUrl: _classPrivateFieldLooseBase(this, _platformUrl)[_platformUrl],
      clientId: _classPrivateFieldLooseBase(this, _clientId)[_clientId],
      scopes
    });
    let token;
    if (!result || (Date.now() - result[0].createdAt) / 1000 > result[0].token.expires_in) {
      provPlatformDebug('Valid access_token for ' + _classPrivateFieldLooseBase(this, _platformUrl)[_platformUrl] + ' not found');
      provPlatformDebug('Attempting to generate new access_token for ' + _classPrivateFieldLooseBase(this, _platformUrl)[_platformUrl]);
      provPlatformDebug('With scopes: ' + scopes);
      token = await Auth.getAccessToken(scopes, this, _classPrivateFieldLooseBase(this, _ENCRYPTIONKEY2)[_ENCRYPTIONKEY2], _classPrivateFieldLooseBase(this, _Database)[_Database]);
    } else {
      provPlatformDebug('Access_token found');
      token = result[0].token;
    }
    token.token_type = token.token_type.charAt(0).toUpperCase() + token.token_type.slice(1);
    return token;
  }

  /**
   * @description Retrieves the platform information as a JSON object.
   */
  async platformJSON() {
    const platformJSON = {
      id: _classPrivateFieldLooseBase(this, _kid)[_kid],
      url: _classPrivateFieldLooseBase(this, _platformUrl)[_platformUrl],
      clientId: _classPrivateFieldLooseBase(this, _clientId)[_clientId],
      name: _classPrivateFieldLooseBase(this, _platformName)[_platformName],
      authenticationEndpoint: _classPrivateFieldLooseBase(this, _authenticationEndpoint)[_authenticationEndpoint],
      accesstokenEndpoint: _classPrivateFieldLooseBase(this, _accesstokenEndpoint)[_accesstokenEndpoint],
      authorizationServer: _classPrivateFieldLooseBase(this, _authorizationServer)[_authorizationServer] || _classPrivateFieldLooseBase(this, _accesstokenEndpoint)[_accesstokenEndpoint],
      authConfig: _classPrivateFieldLooseBase(this, _authConfig2)[_authConfig2],
      publicKey: await this.platformPublicKey(),
      active: await this.platformActive()
    };
    return platformJSON;
  }

  /**
   * @description Deletes a registered platform.
   */
  async delete() {
    await _classPrivateFieldLooseBase(this, _Database)[_Database].Delete('platform', {
      platformUrl: _classPrivateFieldLooseBase(this, _platformUrl)[_platformUrl],
      clientId: _classPrivateFieldLooseBase(this, _clientId)[_clientId]
    });
    await _classPrivateFieldLooseBase(this, _Database)[_Database].Delete('platformStatus', {
      id: _classPrivateFieldLooseBase(this, _kid)[_kid]
    });
    await _classPrivateFieldLooseBase(this, _Database)[_Database].Delete('publickey', {
      kid: _classPrivateFieldLooseBase(this, _kid)[_kid]
    });
    await _classPrivateFieldLooseBase(this, _Database)[_Database].Delete('privatekey', {
      kid: _classPrivateFieldLooseBase(this, _kid)[_kid]
    });
    return true;
  }

  /* istanbul ignore next */
  /**
   * @deprecated
   */
  async remove() {
    console.log('Deprecation warning: The Platform.remove() method is now deprecated and will be removed in the 6.0 release. Use Platform.delete() instead.');
    return this.delete();
  }

  /* istanbul ignore next */
  /**
   * @description Sets/Gets the platform authorization endpoint used to perform the OIDC login.
   * @param {string} [authenticationEndpoint] - Platform authentication endpoint.
   * @deprecated
   */
  async platformAuthEndpoint(authenticationEndpoint) {
    return this.platformAuthenticationEndpoint(authenticationEndpoint);
  }
}
export default Platform;
//# sourceMappingURL=Platform.js.map